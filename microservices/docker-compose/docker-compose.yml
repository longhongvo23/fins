services:
  gateway:
    image: gateway
    environment:
      - _JAVA_OPTIONS=-Xmx512m -Xms256m
      - SPRING_PROFILES_ACTIVE=prod,api-docs
      - MANAGEMENT_PROMETHEUS_METRICS_EXPORT_ENABLED=true
      - SPRING_CLOUD_CONSUL_HOST=consul
      - SPRING_CLOUD_CONSUL_PORT=8500
      - SPRING_DATA_MONGODB_URI=mongodb://${GATEWAY_MONGODB_USER}:${GATEWAY_MONGODB_PASSWORD}@gateway-mongodb:27017/gateway?authSource=admin&waitQueueMultiple=1000
      - SPRING_CLOUD_STREAM_KAFKA_BINDER_BROKERS=kafka:9092
      - JHIPSTER_CORS_ALLOWED_ORIGINS=http://localhost:8100,https://localhost:8100,http://localhost:9000,https://localhost:9000,http://localhost:2601,https://localhost:2601,http://localhost:2302,https://localhost:2302
    ports:
      - 8080:8080
    healthcheck:
      test:
        - CMD
        - curl
        - -f
        - http://localhost:8080/management/health
      interval: 5s
      timeout: 5s
      retries: 40
    depends_on:
      gateway-mongodb:
        condition: service_healthy
  gateway-mongodb:
    image: mongo:8.0.9
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${GATEWAY_MONGODB_USER}
      - MONGO_INITDB_ROOT_PASSWORD=${GATEWAY_MONGODB_PASSWORD}
    healthcheck:
      test:
        - CMD
        - mongosh
        - --eval
        - "db.adminCommand('ping')"
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s

  userservice:
    image: userservice
    environment:
      - _JAVA_OPTIONS=-Xmx512m -Xms256m
      - SPRING_PROFILES_ACTIVE=prod,api-docs
      - MANAGEMENT_PROMETHEUS_METRICS_EXPORT_ENABLED=true
      - SPRING_CLOUD_CONSUL_HOST=consul
      - SPRING_CLOUD_CONSUL_PORT=8500
      - SPRING_DATA_MONGODB_URI=mongodb://${USERSERVICE_MONGODB_USER}:${USERSERVICE_MONGODB_PASSWORD}@userservice-mongodb:27017/userservice?authSource=admin&waitQueueMultiple=1000
      - SPRING_CLOUD_STREAM_KAFKA_BINDER_BROKERS=kafka:9092
    healthcheck:
      test:
        - CMD
        - curl
        - -f
        - http://localhost:8081/management/health
      interval: 5s
      timeout: 5s
      retries: 40
    depends_on:
      userservice-mongodb:
        condition: service_healthy
  userservice-mongodb:
    image: mongo:8.0.9
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${USERSERVICE_MONGODB_USER}
      - MONGO_INITDB_ROOT_PASSWORD=${USERSERVICE_MONGODB_PASSWORD}
    healthcheck:
      test:
        - CMD
        - mongosh
        - --eval
        - "db.adminCommand('ping')"
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s

  notificationservice:
    image: notificationservice
    environment:
      - _JAVA_OPTIONS=-Xmx512m -Xms256m
      - SPRING_PROFILES_ACTIVE=prod,api-docs
      - MANAGEMENT_PROMETHEUS_METRICS_EXPORT_ENABLED=true
      - SPRING_CLOUD_CONSUL_HOST=consul
      - SPRING_CLOUD_CONSUL_PORT=8500
      - SPRING_DATA_MONGODB_URI=mongodb://${NOTIFICATIONSERVICE_MONGODB_USER}:${NOTIFICATIONSERVICE_MONGODB_PASSWORD}@notificationservice-mongodb:27017/notificationservice?authSource=admin&waitQueueMultiple=1000
      - SPRING_CLOUD_STREAM_KAFKA_BINDER_BROKERS=kafka:9092
    healthcheck:
      test:
        - CMD
        - curl
        - -f
        - http://localhost:8082/management/health
      interval: 5s
      timeout: 5s
      retries: 40
    depends_on:
      notificationservice-mongodb:
        condition: service_healthy
  notificationservice-mongodb:
    image: mongo:8.0.9
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${NOTIFICATIONSERVICE_MONGODB_USER}
      - MONGO_INITDB_ROOT_PASSWORD=${NOTIFICATIONSERVICE_MONGODB_PASSWORD}
    healthcheck:
      test:
        - CMD
        - mongosh
        - --eval
        - "db.adminCommand('ping')"
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s

  stockservice:
    image: stockservice
    environment:
      - _JAVA_OPTIONS=-Xmx512m -Xms256m
      - SPRING_PROFILES_ACTIVE=prod,api-docs
      - MANAGEMENT_PROMETHEUS_METRICS_EXPORT_ENABLED=true
      - SPRING_CLOUD_CONSUL_HOST=consul
      - SPRING_CLOUD_CONSUL_PORT=8500
      - SPRING_DATA_MONGODB_URI=mongodb://${STOCKSERVICE_MONGODB_USER}:${STOCKSERVICE_MONGODB_PASSWORD}@stockservice-mongodb:27017/stockservice?authSource=admin&waitQueueMultiple=1000
      - SPRING_CLOUD_STREAM_KAFKA_BINDER_BROKERS=kafka:9092
    healthcheck:
      test:
        - CMD
        - curl
        - -f
        - http://localhost:8083/management/health
      interval: 5s
      timeout: 5s
      retries: 40
    depends_on:
      stockservice-mongodb:
        condition: service_healthy
  stockservice-mongodb:
    image: mongo:8.0.9
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${STOCKSERVICE_MONGODB_USER}
      - MONGO_INITDB_ROOT_PASSWORD=${STOCKSERVICE_MONGODB_PASSWORD}
    healthcheck:
      test:
        - CMD
        - mongosh
        - --eval
        - "db.adminCommand('ping')"
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s

  newsservice:
    image: newsservice
    environment:
      - _JAVA_OPTIONS=-Xmx512m -Xms256m
      - SPRING_PROFILES_ACTIVE=prod,api-docs
      - MANAGEMENT_PROMETHEUS_METRICS_EXPORT_ENABLED=true
      - SPRING_CLOUD_CONSUL_HOST=consul
      - SPRING_CLOUD_CONSUL_PORT=8500
      - SPRING_DATA_MONGODB_URI=mongodb://${NEWSSERVICE_MONGODB_USER}:${NEWSSERVICE_MONGODB_PASSWORD}@newsservice-mongodb:27017/newsservice?authSource=admin&waitQueueMultiple=1000
      - SPRING_CLOUD_STREAM_KAFKA_BINDER_BROKERS=kafka:9092
    healthcheck:
      test:
        - CMD
        - curl
        - -f
        - http://localhost:8084/management/health
      interval: 5s
      timeout: 5s
      retries: 40
    depends_on:
      newsservice-mongodb:
        condition: service_healthy
  newsservice-mongodb:
    image: mongo:8.0.9
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${NEWSSERVICE_MONGODB_USER}
      - MONGO_INITDB_ROOT_PASSWORD=${NEWSSERVICE_MONGODB_PASSWORD}
    healthcheck:
      test:
        - CMD
        - mongosh
        - --eval
        - "db.adminCommand('ping')"
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s

  crawlservice:
    image: crawlservice
    environment:
      - _JAVA_OPTIONS=-Xmx512m -Xms256m
      - SPRING_PROFILES_ACTIVE=prod,api-docs
      - MANAGEMENT_PROMETHEUS_METRICS_EXPORT_ENABLED=true
      - SPRING_CLOUD_CONSUL_HOST=consul
      - SPRING_CLOUD_CONSUL_PORT=8500
      - SPRING_DATA_MONGODB_URI=mongodb://${CRAWLSERVICE_MONGODB_USER}:${CRAWLSERVICE_MONGODB_PASSWORD}@crawlservice-mongodb:27017/crawlservice?authSource=admin&waitQueueMultiple=1000
      - SPRING_CLOUD_STREAM_KAFKA_BINDER_BROKERS=kafka:9092
      - APPLICATION_API_TWELVE_DATA_API_KEY=${TWELVE_DATA_API_KEY}
      - APPLICATION_API_TWELVE_DATA_BASE_URL=${TWELVE_DATA_BASE_URL}
      - APPLICATION_API_FINNHUB_API_KEY=${FINNHUB_API_KEY}
      - APPLICATION_API_FINNHUB_BASE_URL=${FINNHUB_BASE_URL}
      - APPLICATION_API_MARKETAUX_API_KEY=${MARKETAUX_API_KEY}
      - APPLICATION_API_MARKETAUX_BASE_URL=${MARKETAUX_BASE_URL}
      - APPLICATION_STOCK_SYMBOLS_0=AAPL
      - APPLICATION_STOCK_SYMBOLS_1=NVDA
      - APPLICATION_STOCK_SYMBOLS_2=MSFT
      - APPLICATION_STOCK_SYMBOLS_3=AMZN
      - APPLICATION_STOCK_SYMBOLS_4=TSLA
      - APPLICATION_STOCK_SYMBOLS_5=META
      - APPLICATION_STOCK_SYMBOLS_6=GOOGL
      - APPLICATION_STOCK_SERVICE_URL=http://stockservice:8083
      - APPLICATION_NEWS_SERVICE_URL=http://newsservice:8084
      - APPLICATION_CRAWL_SCHEDULE_DAILY_QUOTE=0 0 21 * * ?
      - APPLICATION_CRAWL_SCHEDULE_WEEKLY_RECOMMENDATION=0 0 2 * * MON
      - APPLICATION_CRAWL_SCHEDULE_WEEKLY_COMPANY_PROFILE=0 0 3 * * MON
      - APPLICATION_CRAWL_SCHEDULE_DAILY_NEWS=0 0 10,15,21 * * ?
      - APPLICATION_CRAWL_HISTORICAL_START_DATE=2015-01-01
      - APPLICATION_CRAWL_HISTORICAL_INTERVAL=1day
    healthcheck:
      test:
        - CMD
        - curl
        - -f
        - http://localhost:8085/management/health
      interval: 5s
      timeout: 5s
      retries: 40
    depends_on:
      crawlservice-mongodb:
        condition: service_healthy
      stockservice:
        condition: service_healthy
      newsservice:
        condition: service_healthy
  crawlservice-mongodb:
    image: mongo:8.0.9
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${CRAWLSERVICE_MONGODB_USER}
      - MONGO_INITDB_ROOT_PASSWORD=${CRAWLSERVICE_MONGODB_PASSWORD}
    healthcheck:
      test:
        - CMD
        - mongosh
        - --eval
        - "db.adminCommand('ping')"
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s

  kafka:
    image: apache/kafka-native:4.0.0
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_LISTENERS: PLAINTEXT://:9092,CONTROLLER://localhost:9093
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@localhost:9093
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      # Auto-create topics when producer/consumer connects
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_NUM_PARTITIONS: 3
      KAFKA_DEFAULT_REPLICATION_FACTOR: 1
      #ports:
      # - 9092:9092 # Uncomment to make Kafka available externally
  consul:
    image: hashicorp/consul:latest
    ports:
      - 8300:8300
      - 8500:8500
      - 8600:8600
    command: consul agent -dev -ui -client 0.0.0.0 -log-level=INFO
  consul-config-loader:
    image: jhipster/consul-config-loader:v0.4.1
    volumes:
      - ./central-server-config:/config
    environment:
      - INIT_SLEEP_SECONDS=5
      - CONSUL_URL=consul
      - CONSUL_PORT=8500

  aiservice:
    build:
      context: ../aiservice
      dockerfile: Dockerfile
    image: aiservice
    environment:
      - APP_NAME=aiservice
      - APP_PORT=8086
      - MONGODB_URI=mongodb://${STOCKSERVICE_MONGODB_USER}:${STOCKSERVICE_MONGODB_PASSWORD}@stockservice-mongodb:27017/stockservice?authSource=admin
      - MONGODB_DATABASE=stockservice
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - CONSUL_HOST=consul
      - CONSUL_PORT=8500
      - SERVICE_DISCOVERY_ENABLED=true
      - AUTO_PREDICTION_ENABLED=true
      - LOG_LEVEL=INFO
    ports:
      - 8086:8086
    healthcheck:
      test:
        - CMD
        - python
        - -c
        - "import requests; requests.get('http://localhost:8086/health')"
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    depends_on:
      stockservice-mongodb:
        condition: service_healthy
      kafka:
        condition: service_started
      consul:
        condition: service_started
    restart: unless-stopped

  prometheus:
    image: prom/prometheus:v3.3.1
    volumes:
      - ./prometheus-conf/:/etc/prometheus/
      - prometheus_data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
    ports:
      - 9090:9090
  alertmanager:
    image: prom/alertmanager:v0.28.1
    ports:
      - 9093:9093
    volumes:
      - ./alertmanager-conf/:/etc/alertmanager/
    command:
      - "--config.file=/etc/alertmanager/config.yml"
      - "--storage.path=/alertmanager"

  grafana:
    image: grafana/grafana:12.0.0
    ports:
      - 3000:3000
    volumes:
      - grafana_data:/var/lib/grafana
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false

volumes:
  prometheus_data: {}
  grafana_data: {}
